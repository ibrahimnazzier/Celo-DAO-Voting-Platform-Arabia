<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celo DAO Voting Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #0a0a0a 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(30, 0, 60, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 8px 32px 0 rgba(168, 85, 247, 0.15);
        }

        .glass-card:hover {
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 8px 48px 0 rgba(168, 85, 247, 0.25);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5),
                        0 0 40px rgba(168, 85, 247, 0.3),
                        0 0 60px rgba(168, 85, 247, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 30px rgba(168, 85, 247, 0.6);
            transform: translateY(-2px);
        }

        .btn-yes {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-yes:hover {
            box-shadow: 0 6px 30px rgba(16, 185, 129, 0.6);
        }

        .btn-no {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-no:hover {
            box-shadow: 0 6px 30px rgba(239, 68, 68, 0.6);
        }

        .progress-bar-yes {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.6);
        }

        .progress-bar-no {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
        }

        .cyberpunk-border {
            position: relative;
            overflow: hidden;
        }

        .cyberpunk-border::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #a855f7, transparent);
            animation: scan 3s linear infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .hidden {
            display: none !important;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .sidebar {
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(168, 85, 247, 0.2);
        }
    </style>
</head>
<body class="text-gray-100">
    
    <!-- Main Container -->
    <div class="flex min-h-screen">
        
        <!-- Sidebar -->
        <div class="sidebar w-64 p-6 fixed h-full z-10">
            <div class="mb-10">
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">
                    üó≥Ô∏è Celo DAO
                </h1>
                <p class="text-xs text-gray-400 mt-1">Celo Sepolia Testnet</p>
            </div>

            <nav class="space-y-4">
                <button id="navDashboard" class="w-full text-left px-4 py-3 rounded-lg bg-purple-600/20 text-purple-300 font-medium transition-all">
                    üìä Dashboard
                </button>
                <!-- ADDED: Create Proposal Button -->
                <button id="navCreate" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-purple-600/10 hover:text-purple-300 transition-all">
                    ‚ûï Create Proposal
                </button>
                <button id="navHistory" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-purple-600/10 hover:text-purple-300 transition-all">
                    üìú History
                </button>
                <button id="navSettings" class="w-full text-left px-4 py-3 rounded-lg text-gray-400 hover:bg-purple-600/10 hover:text-purple-300 transition-all">
                    ‚öôÔ∏è Settings
                </button>
            </nav>

            <div class="absolute bottom-6 left-6 right-6">
                <button id="connectWalletBtn" class="btn-primary w-full px-4 py-3 rounded-xl font-semibold text-white transition-all">
                    Connect Wallet
                </button>
                <div id="walletInfo" class="hidden mt-3 p-3 rounded-lg bg-purple-600/10 border border-purple-500/20">
                    <p class="text-xs text-gray-400 mb-1">Connected</p>
                    <p id="walletAddress" class="text-xs font-mono text-purple-300 truncate"></p>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="ml-64 flex-1 p-8">
            
            <!-- Dashboard View -->
            <div id="dashboardView">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-4xl font-bold text-white mb-2">Active Proposals</h2>
                        <p class="text-gray-400">Vote on important governance decisions</p>
                    </div>
                    <!-- ADDED: Header Button -->
                    <button onclick="showCreate()" class="btn-primary px-6 py-2 rounded-lg text-white text-sm font-bold">
                        New Proposal
                    </button>
                </div>

                <!-- Proposals Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="proposalsGrid">
                    <!-- Proposal Card 1 (Static for MVP/Demo) -->
                    <div class="glass-card rounded-2xl p-6 cursor-pointer cyberpunk-border proposal-card" data-proposal-id="0">
                        <div class="flex justify-between items-start mb-4">
                            <span class="status-badge status-active">ACTIVE</span>
                            <span class="text-sm text-gray-400">Proposal #1</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Fund Project A: DeFi Integration</h3>
                        <p class="text-gray-300 mb-4 leading-relaxed">Allocate $50,000 from the treasury to develop a comprehensive DeFi integration module.</p>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-4">
                                <span class="text-green-400 font-semibold">‚úì 245 Yes</span>
                                <span class="text-red-400 font-semibold">‚úó 89 No</span>
                            </div>
                            <span class="text-purple-400 font-semibold hover:text-purple-300">View Details ‚Üí</span>
                        </div>
                    </div>
                    
                    <!-- Proposal Card 2 -->
                    <div class="glass-card rounded-2xl p-6 cursor-pointer cyberpunk-border proposal-card" data-proposal-id="1">
                        <div class="flex justify-between items-start mb-4">
                            <span class="status-badge status-active">ACTIVE</span>
                            <span class="text-sm text-gray-400">Proposal #2</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-3">Change Protocol Fee Structure</h3>
                        <p class="text-gray-300 mb-4 leading-relaxed">Reduce transaction fees from 0.5% to 0.3% to improve competitiveness.</p>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center space-x-4">
                                <span class="text-green-400 font-semibold">‚úì 312 Yes</span>
                                <span class="text-red-400 font-semibold">‚úó 156 No</span>
                            </div>
                            <span class="text-purple-400 font-semibold hover:text-purple-300">View Details ‚Üí</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADDED: Create Proposal View -->
            <div id="createView" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-white mb-2">Create New Proposal</h2>
                    <p class="text-gray-400">Submit a proposal for community voting</p>
                </div>

                <div class="glass-card p-8 rounded-2xl max-w-2xl">
                    <div class="mb-6">
                        <label class="block text-gray-400 mb-2 font-medium">Proposal Title</label>
                        <input type="text" id="newPropTitle" placeholder="e.g., Increase Treasury Allocation" 
                               class="w-full bg-black/50 border border-gray-700 rounded-lg p-4 text-white focus:border-purple-500 focus:outline-none transition-colors">
                    </div>
                    <div class="mb-8">
                        <label class="block text-gray-400 mb-2 font-medium">Description</label>
                        <textarea id="newPropDesc" rows="5" placeholder="Describe your proposal in detail..." 
                                  class="w-full bg-black/50 border border-gray-700 rounded-lg p-4 text-white focus:border-purple-500 focus:outline-none transition-colors"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="createProposal()" class="btn-primary flex-1 py-4 rounded-xl text-white font-bold text-lg">
                            Submit Proposal
                        </button>
                        <button onclick="showDashboard()" class="bg-gray-800 hover:bg-gray-700 flex-1 py-4 rounded-xl text-gray-300 font-bold text-lg transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <!-- History View -->
            <div id="historyView" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-white mb-2">Voting History</h2>
                    <p class="text-gray-400">View your past votes and proposal outcomes</p>
                </div>
                <div class="space-y-4">
                    <div id="noHistoryMessage" class="glass-card rounded-2xl p-12 text-center">
                        <div class="text-6xl mb-4">üìú</div>
                        <h3 class="text-2xl font-bold text-white mb-2">No Voting History</h3>
                        <p class="text-gray-400">You haven't voted on any proposals yet.</p>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="hidden">
                <div class="mb-8">
                    <h2 class="text-4xl font-bold text-white mb-2">Settings</h2>
                    <p class="text-gray-400">Manage your preferences and account settings</p>
                </div>
                <div class="glass-card rounded-2xl p-6 max-w-3xl">
                    <h3 class="text-xl font-bold text-white mb-4">Account</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Connected Wallet</label>
                            <div class="flex items-center justify-between bg-black/30 rounded-lg p-3">
                                <span id="settingsWalletAddress" class="font-mono text-purple-300">Not Connected</span>
                                <button onclick="connectWallet()" class="text-sm text-purple-400 hover:text-purple-300">Reconnect</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">Network</label>
                            <div class="bg-black/30 rounded-lg p-3">
                                <span class="text-white">Celo Sepolia Testnet</span>
                                <span class="ml-2 text-xs text-green-400">‚óè Connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vote Detail View -->
            <div id="voteView" class="hidden">
                <button id="backToDashboard" class="mb-6 text-purple-400 hover:text-purple-300 flex items-center space-x-2 transition-all">
                    <span>‚Üê</span>
                    <span>Back to Dashboard</span>
                </button>

                <div class="glass-card rounded-2xl p-8 max-w-4xl">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span class="status-badge status-active mb-3 inline-block">ACTIVE</span>
                            <h2 id="proposalTitle" class="text-4xl font-bold text-white mb-2">Proposal Title</h2>
                            <p class="text-gray-400">Proposal #<span id="proposalId">1</span></p>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h4 class="text-sm font-semibold text-gray-400 uppercase mb-2">Description</h4>
                        <p id="proposalDescription" class="text-gray-200 leading-relaxed text-lg"></p>
                    </div>

                    <!-- Voting Results -->
                    <div class="mb-8">
                        <h4 class="text-sm font-semibold text-gray-400 uppercase mb-4">Current Results</h4>
                        <div class="mb-4">
                            <div class="flex justify-between mb-2">
                                <span class="text-green-400 font-semibold">Yes Votes</span>
                                <span id="yesVotes" class="text-white font-bold">0</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden">
                                <div id="yesBar" class="progress-bar-yes h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-6">
                            <div class="flex justify-between mb-2">
                                <span class="text-red-400 font-semibold">No Votes</span>
                                <span id="noVotes" class="text-white font-bold">0</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-4 overflow-hidden">
                                <div id="noBar" class="progress-bar-no h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-black/30 rounded-xl p-6">
                            <canvas id="votingChart" height="80"></canvas>
                        </div>
                    </div>

                    <div id="votingStatus" class="hidden mb-6 p-4 rounded-lg"></div>

                    <div class="flex gap-4">
                        <button id="voteYesBtn" class="btn-yes flex-1 py-4 rounded-xl font-bold text-white text-lg transition-all">
                            ‚úì Vote YES
                        </button>
                        <button id="voteNoBtn" class="btn-no flex-1 py-4 rounded-xl font-bold text-white text-lg transition-all">
                            ‚úó Vote NO
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==================== CONTRACT CONFIGURATION ====================
        // ÿπŸÜŸàÿßŸÜ ÿßŸÑÿπŸÇÿØ ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿßŸÑÿ£ÿÆŸäÿ±
        const contractAddress = "0x4d74e29b44f9e5e9391bc395792e6f3b765c7eb4";
        
        // ABI ŸÖÿ≠ÿØÿ´ ÿπÿ¥ÿßŸÜ Ÿäÿπÿ±ŸÅ Ÿäÿ¨Ÿäÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿµÿ≠
        const contractABI = [
            "function vote(uint256 proposalId, bool support) public",
            "function createProposal(string memory title, string memory description) public",
            "function getProposalInfo(uint256 proposalId) public view returns (string memory title, string memory description, uint256 yesVotes, uint256 noVotes, bool isActive)",
            "function hasVoted(uint256 proposalId, address voter) public view returns (bool)",
            "function proposalCount() public view returns (uint256)"
        ];

        const CELO_TESTNET_CONFIG = {
            chainId: '0xaa044c',
            chainName: 'Celo Sepolia Testnet',
            nativeCurrency: { name: 'CELO', symbol: 'CELO', decimals: 18 },
            rpcUrls: ['https://forno.celo-sepolia.celo-testnet.org'],
            blockExplorerUrls: ['https://sepolia.celoscan.io/']
        };

        let provider, signer, contract, userAddress;
        let currentProposalId = null;
        let votingChart = null;

        // ==================== CORE FUNCTIONS ====================

        async function connectWallet() {
            if (!window.ethereum) return alert("Please install MetaMask!");
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Switch Network
                try {
                    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_TESTNET_CONFIG.chainId }] });
                } catch (error) {
                    if (error.code === 4902) await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [CELO_TESTNET_CONFIG] });
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(contractAddress, contractABI, signer);

                updateWalletUI();
                loadProposals(); // Load Real Data
            } catch (err) {
                console.error(err);
                alert("Connection Error: " + err.message);
            }
        }

        // Ÿáÿ∞Ÿá ŸáŸä ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑŸáÿß ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÖŸÇÿ™ÿ±ÿ≠ÿßÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸäÿ©
        async function loadProposals() {
            const grid = document.getElementById('proposalsGrid');
            grid.innerHTML = '<div class="text-white">Loading proposals from blockchain...</div>';

            if (!contract) return;

            try {
                // 1. Get total count
                const count = await contract.proposalCount();
                const total = count.toNumber();

                grid.innerHTML = ''; // Clear loading

                if (total === 0) {
                    grid.innerHTML = '<div class="text-gray-400">No proposals found. Create one!</div>';
                    return;
                }

                // 2. Loop and fetch each proposal
                for (let i = 0; i < total; i++) {
                    const prop = await contract.getProposalInfo(i);
                    
                    const card = document.createElement('div');
                    card.className = 'glass-card p-6 rounded-2xl cursor-pointer hover:bg-white/5 transition';
                    card.onclick = () => openProposal(i, prop.title, prop.description, prop.yesVotes, prop.noVotes);
                    
                    card.innerHTML = `
                        <div class="flex justify-between mb-4">
                            <span class="status-badge status-active">ACTIVE</span>
                            <span class="text-gray-400">#${i+1}</span>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2">${prop.title}</h3>
                        <p class="text-gray-400 text-sm line-clamp-2">${prop.description}</p>
                        <div class="mt-4 flex gap-4 text-sm">
                            <span class="text-green-400">üëç ${prop.yesVotes}</span>
                            <span class="text-red-400">üëé ${prop.noVotes}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                }
            } catch (e) {
                console.error("Error loading proposals:", e);
                grid.innerHTML = '<div class="text-red-400">Error loading data. Make sure you are on Celo Sepolia.</div>';
            }
        }

        function updateWalletUI() {
            document.getElementById('connectWalletBtn').innerText = "Connected";
            document.getElementById('walletInfo').classList.remove('hidden');
            document.getElementById('walletAddress').innerText = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        }

        // ==================== ACTIONS ====================

        async function createProposal() {
            if (!contract) return alert("Connect wallet first!");
            const title = document.getElementById('newPropTitle').value;
            const desc = document.getElementById('newPropDesc').value;
            
            if(!title || !desc) return alert("Fill all fields");

            try {
                const tx = await contract.createProposal(title, desc, { gasLimit: 600000 });
                alert("Transaction sent! Please wait...");
                await tx.wait();
                alert("Proposal Created! Reloading...");
                
                // Clear inputs and reload
                document.getElementById('newPropTitle').value = '';
                document.getElementById('newPropDesc').value = '';
                showDashboard();
                loadProposals(); 
            } catch (err) {
                alert("Error: " + (err.reason || err.message));
            }
        }

        async function vote(support) {
            if (!contract) return alert("Connect wallet first!");
            const status = document.getElementById('votingStatus');
            status.classList.remove('hidden');
            status.innerText = "‚è≥ Processing vote...";

            try {
                const tx = await contract.vote(currentProposalId, support, { gasLimit: 300000 });
                status.innerText = "Wait for confirmation...";
                await tx.wait();
                status.innerText = "‚úÖ Voted Successfully!";
                
                // Refresh data
                const prop = await contract.getProposalInfo(currentProposalId);
                updateBars(prop.yesVotes, prop.noVotes);
                loadProposals(); // Refresh grid too
            } catch (err) {
                console.error(err);
                status.innerText = "‚ùå Error: " + (err.reason || "Transaction failed");
            }
        }

        // ==================== UI HELPERS ====================

        function openProposal(id, title, desc, yes, no) {
            currentProposalId = id;
            hideAll();
            document.getElementById('voteView').classList.remove('hidden');
            
            document.getElementById('proposalTitle').innerText = title;
            document.getElementById('proposalDescription').innerText = desc;
            // Convert BigNumber if needed
            updateBars(yes.toNumber ? yes.toNumber() : yes, no.toNumber ? no.toNumber() : no);
        }

        function updateBars(yes, no) {
            document.getElementById('yesVotes').innerText = yes;
            document.getElementById('noVotes').innerText = no;
            const total = yes + no;
            document.getElementById('yesBar').style.width = total ? (yes/total)*100 + '%' : '0%';
            document.getElementById('noBar').style.width = total ? (no/total)*100 + '%' : '0%';
            
            // Update Chart
            const ctx = document.getElementById('votingChart').getContext('2d');
            if (votingChart) votingChart.destroy();
            votingChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Yes', 'No'], datasets: [{ data: [yes, no], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
            });
        }

        function showDashboard() { hideAll(); document.getElementById('dashboardView').classList.remove('hidden'); }
        function showCreate() { hideAll(); document.getElementById('createView').classList.remove('hidden'); }
        function showHistory() { hideAll(); document.getElementById('historyView').classList.remove('hidden'); }
        function showSettings() { hideAll(); document.getElementById('settingsView').classList.remove('hidden'); }
        
        function hideAll() {
            ['dashboardView', 'createView', 'historyView', 'settingsView', 'voteView'].forEach(id => 
                document.getElementById(id).classList.add('hidden'));
        }

        // Listeners
        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
        document.getElementById('navDashboard').addEventListener('click', showDashboard);
        document.getElementById('navCreate').addEventListener('click', showCreate);
        document.getElementById('navHistory').addEventListener('click', showHistory);
        document.getElementById('navSettings').addEventListener('click', showSettings);
        document.getElementById('backToDashboard').addEventListener('click', showDashboard);
    </script>
</body>
</html>
